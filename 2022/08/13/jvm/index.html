<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>jvm | TQYSH</title><meta name="keywords" content="java JVM"><meta name="author" content="yasooh"><meta name="copyright" content="yasooh"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="序JVM?​	java virtual machine java的运行环境（二进制字节码） 优点 一次编写，到处运行 自动内存管理，垃圾回收功能 数组下标越界检查 多态  比较​	 路线 内存结构程序计数器(寄存器)​	program counter register ​	作用：就是记住下一条指令的执行地址，以便阻塞后恢复时找得到继续的位置，或者是解释器将字节码转为机器码交给cpu执行完后再回来找">
<meta property="og:type" content="article">
<meta property="og:title" content="jvm">
<meta property="og:url" content="http://example.com/2022/08/13/jvm/index.html">
<meta property="og:site_name" content="TQYSH">
<meta property="og:description" content="序JVM?​	java virtual machine java的运行环境（二进制字节码） 优点 一次编写，到处运行 自动内存管理，垃圾回收功能 数组下标越界检查 多态  比较​	 路线 内存结构程序计数器(寄存器)​	program counter register ​	作用：就是记住下一条指令的执行地址，以便阻塞后恢复时找得到继续的位置，或者是解释器将字节码转为机器码交给cpu执行完后再回来找">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2022-08-13T07:23:32.000Z">
<meta property="article:modified_time" content="2022-10-12T09:54:33.114Z">
<meta property="article:author" content="yasooh">
<meta property="article:tag" content="java JVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/08/13/jvm/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'jvm',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-12 17:54:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/QQ%E5%9B%BE%E7%89%8720221013163946.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">TQYSH</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">jvm</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-13T07:23:32.000Z" title="发表于 2022-08-13 15:23:32">2022-08-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-12T09:54:33.114Z" title="更新于 2022-10-12 17:54:33">2022-10-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="jvm"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="序"><a href="#序" class="headerlink" title="序"></a>序</h1><h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM?"></a>JVM?</h2><p>​	java virtual machine java的运行环境（二进制字节码）</p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul>
<li>一次编写，到处运行</li>
<li>自动内存管理，垃圾回收功能</li>
<li>数组下标越界检查</li>
<li>多态</li>
</ul>
<h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><p>​	<img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831023844363.png" alt="image-20220831023844363"></p>
<h2 id="路线"><a href="#路线" class="headerlink" title="路线"></a>路线</h2><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831023950436.png" alt="image-20220831023950436"></p>
<h1 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h1><h2 id="程序计数器-寄存器"><a href="#程序计数器-寄存器" class="headerlink" title="程序计数器(寄存器)"></a>程序计数器(寄存器)</h2><p>​	program counter register</p>
<p>​	<strong>作用：</strong>就是记住下一条指令的执行地址，以便阻塞后恢复时找得到继续的位置，或者是解释器将字节码转为机器码交给cpu执行完后再回来找下一行的标记。</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831024529560.png" alt="image-20220831024529560"></p>
<p>​	<strong>特点：</strong></p>
<ol>
<li>线程私有的（每个线程都得有，不然回来拿什么找继续的位置）</li>
<li>不会存在内存溢出</li>
</ol>
<h2 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>​	Java Virtual Machine Stacks  </p>
<ul>
<li><p>其实就是每个线程运行所需要的内存空间</p>
</li>
<li><p>由栈帧(frame)组成，对应每次方法调用时所占用的内存</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831025602838.png" alt="image-20220831025602838"></p>
</li>
</ul>
<p>​		方法一调用方法二调用方法三</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831025747243.png" alt="image-20220831025747243"></p>
<ul>
<li>每个栈只有一个活动栈帧，对应当前正在执行的那个方法</li>
</ul>
<h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831030208969.png" alt="image-20220831030208969"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831030255117.png" alt="image-20220831030255117"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831030309933.png" alt="image-20220831030309933"></p>
<h3 id="垃圾回收管栈内存吗？"><a href="#垃圾回收管栈内存吗？" class="headerlink" title="垃圾回收管栈内存吗？"></a>垃圾回收管栈内存吗？</h3><p>​	不管，栈内存只不过是一次次的方法调用所产生的栈帧内存，每次调用结束后就从栈中弹出，自动回收。</p>
<h3 id="栈内存分配越大越好吗？"><a href="#栈内存分配越大越好吗？" class="headerlink" title="栈内存分配越大越好吗？"></a>栈内存分配越大越好吗？</h3><p>​	栈内存越大，反而线程数会变少，总内存不变，栈内存变大了，线程可用的就少了。栈内存过大，只是可调用的方法可以多，并不会提升性能</p>
<h3 id="方法内的局部变量是否线程安全？"><a href="#方法内的局部变量是否线程安全？" class="headerlink" title="方法内的局部变量是否线程安全？"></a>方法内的局部变量是否线程安全？</h3><p>​	是否线程安全就要看对多个线程来说，变量是共享的还是私有的。而局部变量是线程私有的，所以线程安全。如果变量改成static的就会产生线程安全的问题</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831031357650.png" alt="image-20220831031357650"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831031425521.png" alt="image-20220831031425521"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831031739479.png" alt="image-20220831031739479"></p>
<p>​	以上三个方法，第一个sb在方法内部，属于线程私有，故线程安全。第二个sb是方法的一个参数，有可能有其他的线程能访问到，故非线程安全。第三个sb被反回了，其他的线程有可能拿到，故非线程安全</p>
<p>​	<strong>总结</strong></p>
<ol>
<li>方法内部的局部变量没有逃离方法的作用访问，它是线程安全的</li>
<li>如果局部变量引用了对象，并逃离了方法的作用范围，需要考虑线程安全</li>
</ol>
<h3 id="栈内存溢出"><a href="#栈内存溢出" class="headerlink" title="栈内存溢出"></a>栈内存溢出</h3><p>​	<img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831032654013.png" alt="image-20220831032654013"></p>
<ul>
<li><p>​	栈帧过多</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831032403453.png" alt="image-20220831032403453"></p>
</li>
<li><p>​    栈帧过大（不易出现，默认栈大小1m左右）</p>
</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831032415977.png" alt="image-20220831032415977"></p>
<h2 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h2><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831023950436.png" alt="image-20220831023950436"></p>
<p>native method stacks</p>
<p>​	java代码不能直接与os打交道，需要用c或c++编写的本地方法来做事，java代码调用即可，这些本地方法运行时所需要的内存就是本地方法栈</p>
<p>​	例如：wait()、notify()、notifyall()、clone()</p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>heap</p>
<p>​	通过new关键字，创建的对象都会使用堆内存</p>
<p><strong>特点</strong></p>
<ul>
<li>线程共享，堆中的对象都需要考虑线程安全的问题</li>
<li>有垃圾回收机制</li>
</ul>
<h3 id="堆内存溢出"><a href="#堆内存溢出" class="headerlink" title="堆内存溢出"></a>堆内存溢出</h3><p>​	不断的产生对象，并且之前的在使用，会产生堆内存溢出</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831034524424.png" alt="image-20220831034524424"></p>
<h3 id="堆内存诊断"><a href="#堆内存诊断" class="headerlink" title="堆内存诊断"></a>堆内存诊断</h3><ul>
<li>jps工具：查看系统中有哪些java进程</li>
<li>jmap工具：查看某一时刻的堆内存使用情况</li>
<li>jconsole工具：图形化、多功能监测工具、能连续监测</li>
<li>jvisual</li>
</ul>
<h2 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>​	所有线程共享的区域，存储了跟类结构相关的信息，field()成员变量、method()方法数据、成员方法和构造器方法的代码部分等等和<strong>run-time constant pool运行时常量池</strong></p>
<p>​	逻辑上是堆的一部分，不强调位置</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831023950436.png" alt="image-20220831023950436"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831040348259.png" alt="image-20220831040348259"></p>
<h3 id="内存溢出"><a href="#内存溢出" class="headerlink" title="内存溢出"></a>内存溢出</h3><p>jdk1.8</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831040618910.png" alt="image-20220831040618910"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831040632125.png" alt="image-20220831040632125"></p>
<p>jdk1.6</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831040719636.png" alt="image-20220831040719636"></p>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>spring :cglib生成代理类，aop的核心</p>
<p>mybatis：cglib产生mapper接口的实现类</p>
<h3 id="运行时常量池（StringTable是其中重要的组成部分，又称串池）"><a href="#运行时常量池（StringTable是其中重要的组成部分，又称串池）" class="headerlink" title="运行时常量池（StringTable是其中重要的组成部分，又称串池）"></a>运行时常量池（StringTable是其中重要的组成部分，又称串池）</h3><p><strong>二进制字节码</strong>：类基本信息、常量池、类方法定义、包含了虚拟机指令</p>
<p><strong>常量池：</strong>一张表，jvm指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息</p>
<p><strong>运行时常量池：</strong>常量池是 *.class 文件中的，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址  </p>
<h4 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831042919010.png" alt="image-20220831042919010"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831043243074.png" alt="image-20220831043243074"></p>
<p>sb,toString()，创建了一个新的String对象 new String(“ab”);</p>
<p><strong>所以这里s3&#x3D;&#x3D;s4为FALSE</strong>  s3的ab在常量池中、s4的ab相当于是一个对象，在堆中，是两个对象</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831043806806.png" alt="image-20220831043806806"></p>
<p>s5，字节码显示(29) 直接在常量池中找到了ab，和(6)一样，所以s3,s5指向的是一个ab，<strong>所以s3&#x3D;&#x3D;s5为true</strong>，原因是在javac在编译期间的优化，结果在编译期间确定为ab</p>
<h4 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h4><ul>
<li>常量池中的字符串仅是符号，因为在字节码中，首次用到时才变为对象</li>
<li>利用串池机制，避免重复创建字符串对象</li>
<li>字符串拼接原理是StringBuilder(jdk1.8)</li>
<li>字符串常量拼接的原理是编译器优化</li>
<li>intern(),主动将串池中没有的字符串对象放入串池</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831045158931.png" alt="image-20220831045158931"></p>
<p>此时，ab不在串池中，串池中只有a,b</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831045410531.png" alt="image-20220831045410531"></p>
<p>这里，两个输出都为true</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831045636488.png" alt="image-20220831045636488"></p>
<p>s在堆中，ab在串池中，所以最后一个输出为false，s2和x都指向串池中的ab，第一个输出为true</p>
<p>在1.8和1.6中intern方法有区别，1.6中将字符串放入常量池的时候，如果已存在，1.8返回这个存在的字符串，1.6把对象复制一份放入串池</p>
<h4 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h4><p>1.8</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831050532530.png" alt="image-20220831050532530"></p>
<p>调换顺序，最后一个结果为true</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831050747010.png" alt="image-20220831050747010"></p>
<p>换成1.6，最后一个为false</p>
<h4 id="位置"><a href="#位置" class="headerlink" title="位置"></a>位置</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831051212273.png" alt="image-20220831051212273"></p>
<p>永久代的gc效率很低，需要fullgc才会触发，导致StringTable的回收效率不高，一个java程序中大量的字符串常量对象都会分配到StringTable占用大量的内存，进而导致永久代内存不足。从1.7开始，StringTable转移到堆，minorgc就会出发垃圾回收，大大减轻了内存压力</p>
<p>1.6</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831101857889.png" alt="image-20220831101857889"></p>
<p>1.8<img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831102849703.png" alt="image-20220831102849703"></p>
<p>98%的时间花在回收，却只有2%的堆空间被回收，会报如上错误</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831103124729.png" alt="image-20220831103124729"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831103147665.png" alt="image-20220831103147665"></p>
<h4 id="StringTable垃圾回收"><a href="#StringTable垃圾回收" class="headerlink" title="StringTable垃圾回收"></a>StringTable垃圾回收</h4><p>堆内存占用情况</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831103952866.png" alt="image-20220831103952866"></p>
<p>类字节码里的符号表</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831104007829.png" alt="image-20220831104007829"></p>
<p>StringTable 占用内存详细信息(底层是哈希表)</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831104109385.png" alt="image-20220831104109385"></p>
<p>加100个字符串对象</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831104402089.png" alt="image-20220831104402089"></p>
<p>加10000个</p>
<p>触发了垃圾回收</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831104443484.png" alt="image-20220831104443484"></p>
<h4 id="StringTable性能调优"><a href="#StringTable性能调优" class="headerlink" title="StringTable性能调优"></a>StringTable性能调优</h4><p>与hashtable的桶的个数有关，提前设置StringTableSize&#x3D;&#x3D;200000,耗费时间0.4s</p>
<p>入池四十多万个单词，</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831104756322.png" alt="image-20220831104756322"></p>
<p>设置为最小值1009，费时12s</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831105038785.png" alt="image-20220831105038785"></p>
<ul>
<li>调整-XX:StringTableSize&#x3D;桶个数</li>
<li>考虑将字符串对象是否入池</li>
</ul>
<p>循环读40万个单词进入，并采用intern方法</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831105618265.png" alt="image-20220831105618265"></p>
<p>读文件之前</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831105735633.png" alt="image-20220831105735633"></p>
<p>没intren之前</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831105844557.png" alt="image-20220831105844557"></p>
<p>加intern之后</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831105910701.png" alt="image-20220831105910701"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831105953634.png" alt="image-20220831105953634"></p>
<h2 id="直接内存（Direct-Memory）"><a href="#直接内存（Direct-Memory）" class="headerlink" title="直接内存（Direct Memory）"></a>直接内存（Direct Memory）</h2><h3 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h3><ul>
<li>常用于NIO操作,用于数据缓冲区</li>
<li>分配回收成本较高，读写性能较高</li>
<li>不收jvm内存回收管理</li>
</ul>
<p>io用的传统的阻塞io编写</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831110548342.png" alt="image-20220831110548342"></p>
<p>bytebuffer用的是直接内存</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831110722523.png" alt="image-20220831110722523"></p>
<p>结果对比</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831110412181.png" alt="image-20220831110412181"></p>
<p>原理图</p>
<p>普通io</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831111504392.png" alt="image-20220831111504392"></p>
<p>os画出一块内存，java代码可以直接访问</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831111657578.png" alt="image-20220831111657578"></p>
<h3 id="内存溢出-1"><a href="#内存溢出-1" class="headerlink" title="内存溢出"></a>内存溢出</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831111856980.png" alt="image-20220831111856980"></p>
<h3 id="释放原理"><a href="#释放原理" class="headerlink" title="释放原理"></a>释放原理</h3><p>Unsafe类：非常底层的一个类，一般由jvm调用，分配释放内存</p>
<p>通过反射获得unsafe类的对象</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831112429951.png" alt="image-20220831112429951"></p>
<p>追bytebuffer的源码</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831112617725.png" alt="image-20220831112617725"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831112627358.png" alt="image-20220831112627358"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831112640389.png" alt="image-20220831112640389"></p>
<p>Cleaner:虚引用类型，当它所关联的对象回收时会调用Cleaner的clean方法，执行任务对象的run方法</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831112711383.png" alt="image-20220831112711383"></p>
<ul>
<li>使用了Unsafe对象完成了直接内存的分配回收，并且回收需要主动调用freeMemory方法</li>
<li>ByteBuffer的实现内部类，使用了Cleaner（是个虚引用）来监测ByteBuffer对象，一旦这个对象<strong>被垃圾回收</strong>，那么就会由ReferenceHandler线程（用来监视虚引用的线程，是一个守护线程）通过Cleaner的clean方法调用freeMemory来释放直接内存</li>
</ul>
<h1 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h1><p>堆存在垃圾回收的机制</p>
<h2 id="如何判断对象可以回收"><a href="#如何判断对象可以回收" class="headerlink" title="如何判断对象可以回收"></a>如何判断对象可以回收</h2><h3 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h3><p>被其他对象引用+1，不引用-1</p>
<h4 id="弊端"><a href="#弊端" class="headerlink" title="弊端"></a>弊端</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831114050428.png" alt="image-20220831114050428"></p>
<p>不言而喻</p>
<h3 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h3><p><strong>根对象（GC ROOT）：</strong>肯定不能被当成垃圾回收的对象</p>
<p>如果被跟对象直接或间接引用，则不能回收，反之作为垃圾</p>
<h4 id="哪些是gc-root？"><a href="#哪些是gc-root？" class="headerlink" title="哪些是gc root？"></a>哪些是gc root？</h4><h5 id="基础类"><a href="#基础类" class="headerlink" title="基础类"></a>基础类</h5><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831114828155.png" alt="image-20220831114828155"></p>
<h5 id="native类"><a href="#native类" class="headerlink" title="native类"></a>native类</h5><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831114908837.png" alt="image-20220831114908837"></p>
<h5 id="Busy-Monitor-加了锁的对象"><a href="#Busy-Monitor-加了锁的对象" class="headerlink" title="Busy Monitor,加了锁的对象"></a>Busy Monitor,加了锁的对象</h5><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831114958303.png" alt="image-20220831114958303"></p>
<h5 id="活动的线程中局部变量所引用的对象"><a href="#活动的线程中局部变量所引用的对象" class="headerlink" title="活动的线程中局部变量所引用的对象"></a>活动的线程中局部变量所引用的对象</h5><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831115019639.png" alt="image-20220831115019639"></p>
<p>​	绿色的相当于一个个的栈帧</p>
<p>​	主线程</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831115123213.png" alt="image-20220831115123213"></p>
<h3 id="四种引用"><a href="#四种引用" class="headerlink" title="四种引用"></a>四种引用</h3><p>实线代表强引用，其实沿着GcRoot的引用链能够找到，就不会被垃圾回收A1、A2、A3、ByteBuffer|、A4</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831115818853.png" alt="image-20220831115818853"></p>
<p>长虚线代表软引用，A2，当垃圾回收完时，<strong>发现内存不够</strong>，就把软引用回收掉</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831124153020.png" alt="image-20220831124153020"></p>
<p>短虚线代表弱引用，回收条件更宽松，只要发生垃圾回收，都回收弱引用</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831124253352.png" alt="image-20220831124253352"></p>
<p>软引用和弱引用自身也是一个对象，当它们引用的对象被回收后，它们就会被放入引用队列，以便释放。</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831124604469.png" alt="image-20220831124604469"></p>
<p>虚引用和终结器引用必须配合引用队列使用</p>
<p>在虚引用引用的对象被垃圾回收时，虚引用自己被放入引用队列，从而间接的用一个线程调用虚引用对象的方法</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831125013951.png" alt="image-20220831125013951"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831125030892.png" alt="image-20220831125030892"></p>
<p>终结器引用</p>
<p>没有gcroot指向的对象，jvm自动创建终结器引用</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831125611732.png" alt="image-20220831125611732"></p>
<p>当A4被回收时，放引用入队列，由一个优先级很低的线程finalizeHandler来释放，根据引用找到对象调用其finalize()。因此效率低，所以不推荐用finalize()释放内存</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831125634594.png" alt="image-20220831125634594"></p>
<ol>
<li>强引用<ul>
<li>只有所有gcroots对象，都不通过该引用引用，该对象才能被垃圾回收</li>
</ul>
</li>
<li>软引用(SoftReference)<ul>
<li>仅有软引用应用该对象时，垃圾回收后发现内存不足，再次触发垃圾回收，回收软引用指向的对象</li>
<li>可以配合引用队列释放引用自身</li>
</ul>
</li>
<li>弱引用(WeakReference)<ul>
<li>仅有弱引用引用该对象时，垃圾回收时无论内存是否充足，都会回收弱引用的对象</li>
<li>可以配合引用队列释放引用自身</li>
</ul>
</li>
<li>虚引用(PhantomReference)<ul>
<li>必须配和引用队列使用，主要配和ByteBuffer使用，被引用对象回收时，将虚引用入队，有ReferenceHandler线程调用虚引用相关方法释放直接内存</li>
</ul>
</li>
<li>终结器引用(FinalRenenerce)<ul>
<li>无需手动编码，内部配和引用队列使用，垃圾回收时，终结器引用入队，再由FinalizerHandler线程通过终结器引用找到被引用的对象，执行其finalize()方法，第二次垃圾回收时才能回收被引用对象</li>
</ul>
</li>
</ol>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831131503070.png" alt="image-20220831131503070"></p>
<p>改为软引用</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831135436478.png" alt="image-20220831135436478"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831135713730.png" alt="image-20220831135713730"></p>
<p>结合引用队列实现清理无用的软引用</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831140121397.png" alt="image-20220831140121397"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831140147882.png" alt="image-20220831140147882"></p>
<p>弱引用</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831140352968.png" alt="image-20220831140352968"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831140424200.png" alt="image-20220831140424200"></p>
<h2 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h2><h3 id="标记清除"><a href="#标记清除" class="headerlink" title="标记清除"></a>标记清除</h3><p>容易产生内存碎片</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831140745569.png" alt="image-20220831140745569"></p>
<h3 id="标记整理"><a href="#标记整理" class="headerlink" title="标记整理"></a>标记整理</h3><p>整理阶段，移动内存。消除碎片，然而移动的过程中牵扯到对象的整理，如果对象有引用也要改变引用的地址，导致速度很慢</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831140943572.png" alt="image-20220831140943572"></p>
<h3 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h3><p>标记，复制，交换from和to，但是需要双倍的内存空间</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831141231244.png" alt="image-20220831141231244"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831141251216.png" alt="image-20220831141251216"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831141317504.png" alt="image-20220831141317504"></p>
<h2 id="分代回收"><a href="#分代回收" class="headerlink" title="分代回收"></a>分代回收</h2><h4 id="过程分析"><a href="#过程分析" class="headerlink" title="过程分析"></a>过程分析</h4><p>长时间使用的对象放在老年代中，用完了要丢弃的对象放在新生代<img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831141906897.png" alt="image-20220831141906897"></p>
<p>新建的对象放在伊甸园中</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831142022257.png" alt="image-20220831142022257"></p>
<p>继续新建对象，伊甸园放不下了，就会触发gc，叫做<strong>MinorGc</strong>，小的垃圾回收动作，沿着<strong>gcroot</strong>利用<strong>可达性分析算法</strong>去找哪些对象可以被回收，进行一次<strong>标记</strong>的动作，标志成功后进行一次<strong>复制</strong>动作，把存货的对象复制到<strong>幸存区To</strong>中,<strong>将幸存的对象寿命加1</strong></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831142740022.png" alt="image-20220831142740022"><strong>交换幸存区from和to的位置</strong></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831142825239.png" alt="image-20220831142825239"></p>
<p>把新对象放进去</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831142916962.png" alt="image-20220831142916962"></p>
<p>又过段时间，伊甸园又满了，这时除了要找伊甸园中存活的以外，还要找幸存区的存活对象</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831143035648.png" alt="image-20220831143035648"></p>
<p>再将标记的对象清除，加入新的对象，在把伊甸园存活的对象加入幸存区To，寿命+1.幸存区From的存活对象放入幸存区To，<strong>寿命再加一</strong>，交换from和to的位置</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831143629955.png" alt="image-20220831143629955"></p>
<p><strong>如此反复，如何幸存区的寿命超过一个阈值，移到老年代</strong></p>
<p>如果来一个对象时发现哪都放不下了，触发<strong>FullGc</strong></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831143756161.png" alt="image-20220831143756161"></p>
<ul>
<li>对象首先分配到伊甸园区域</li>
<li>新生代空间不足，触发minor gc，伊甸园和from存活的对象使用copy复制到to中，存活的对象年龄+1并且交换from to</li>
<li>minor gc会引发stop the world ，暂停其他用户的线程（防止回收时，被其他线程改变对象地址）</li>
<li>当对象寿命超过阈值时，会晋升到老年代，最大15（4bit)</li>
<li>当老年代空间不足，会先尝试触发minor gc，之后仍不足，触发full gc，stop the world的时间会更长</li>
<li>还不行就触发outofmemory</li>
</ul>
<h4 id="VM参数"><a href="#VM参数" class="headerlink" title="VM参数"></a>VM参数</h4><table>
<thead>
<tr>
<th>含义</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>堆初始大小</td>
<td>-Xms</td>
</tr>
<tr>
<td>堆最大大小</td>
<td>-Xmx 或 -XX:MaxHeapSize&#x3D;size</td>
</tr>
<tr>
<td>新生代大小</td>
<td>-Xmn 或 (-XX:NewSize&#x3D;size + -XX:MaxNewSize&#x3D;size )</td>
</tr>
<tr>
<td>幸存区比例（动态）</td>
<td>-XX:InitialSurvivorRatio&#x3D;ratio 和 -XX:+UseAdaptiveSizePolicy</td>
</tr>
<tr>
<td>幸存区比例</td>
<td>-XX:SurvivorRatio&#x3D;ratio</td>
</tr>
<tr>
<td>晋升阈值</td>
<td>-XX:MaxTenuringThreshold&#x3D;threshold</td>
</tr>
<tr>
<td>晋升详情</td>
<td>-XX:+PrintTenuringDistribution</td>
</tr>
<tr>
<td>GC详情</td>
<td>-XX:+PrintGCDetails -verbose:gc</td>
</tr>
<tr>
<td>FullGC前MinorGc</td>
<td>-XX:+ScavengeBeforeFullGC</td>
</tr>
</tbody></table>
<h4 id="GC分析"><a href="#GC分析" class="headerlink" title="GC分析"></a>GC分析</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831150503601.png" alt="image-20220831150503601"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831150411276.png" alt="image-20220831150411276"></p>
<ol>
<li>新生代：分配了10M,显示9216k，留出1m给to，使用了2.3m，伊甸园被用了28%，加载了一些类，创建了一些对象</li>
<li>老年代：还没用</li>
</ol>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831150819968.png" alt="image-20220831150819968"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831150907812.png" alt="image-20220831150907812"></p>
<ol>
<li>出现了一个gc信息是minorgc，defnew表示发生在新生代</li>
<li>一些对象放入了to中（交换了from和to的位置）</li>
</ol>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831151111106.png"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831151202754.png" alt="image-20220831151202754"></p>
<p>加了512k</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831151314659.png" alt="image-20220831151314659"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831151410453.png" alt="image-20220831151410453"></p>
<p>再加512k</p>
<ol>
<li>很多对象晋升到了老年代</li>
</ol>
<h4 id="大对象直接晋升老年代"><a href="#大对象直接晋升老年代" class="headerlink" title="大对象直接晋升老年代"></a>大对象直接晋升老年代</h4><p>新生代肯定不够的情况下</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831151559311.png" alt="image-20220831151559311"></p>
<p>直接装不下，进行了最后的自救，minorgc fullgc</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831151719947.png" alt="image-20220831151719947"></p>
<p>另开一个线程，outofmemory了，不会导致主线程结束</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831152004124.png" alt="image-20220831152004124"></p>
<h2 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h2><ol>
<li>串行<ul>
<li>单线程</li>
<li>堆内存较小，适合个人电脑</li>
</ul>
</li>
<li>吞吐量优先(垃圾回收时间占运行时间的比例  )<ul>
<li>多线程</li>
<li>堆内存较大，多核cpu</li>
<li>让单位时间内stoptheworld时间最短0.2 + 0.2 &#x3D;0.4</li>
</ul>
</li>
<li>响应时间优先<ul>
<li>多线程</li>
<li>堆内存较大，多核cpu</li>
<li>让单词stoptheworld时间尽可能短0.1 0.1 0.1 0.1 0.1 0.5</li>
</ul>
</li>
</ol>
<h3 id="串行"><a href="#串行" class="headerlink" title="串行"></a>串行</h3><p>serial使用复制算法 （新生代）</p>
<p>serialold使用标记整理算法（老年代）</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831153327383.png" alt="image-20220831153327383"></p>
<h3 id="吞吐量优先"><a href="#吞吐量优先" class="headerlink" title="吞吐量优先"></a>吞吐量优先</h3><p>cpu利用率飙升</p>
<ol>
<li>第一行，代表新生代（复制算法），到表老年代（标记整理）</li>
<li>第二行，采用自适应的大小调整策略</li>
<li>第三行，调整吞吐量（gctime&#x2F;总时间） ，1&#x2F;1+ratio,(ratio默认99，一般设19)，也就是gctime不能超过总时间的百分之一，如果不达标，jvm会增大堆的大小</li>
<li>第四行，最大暂停毫秒数，默认200ms，和3矛盾</li>
<li>第五行，设置cpu的个数</li>
</ol>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831154920163.png" alt="image-20220831154920163"></p>
<h3 id="响应时间优先"><a href="#响应时间优先" class="headerlink" title="响应时间优先"></a>响应时间优先</h3><p>concurrent并发的意思</p>
<ol>
<li>老年代（并发的标记清除算法）、新生代（复制算法），如果碎片过多并发失败，老年代会退回SerialOld，从而用标记整理算法整理内存</li>
<li>并行的cpu线程数默认4，并发的cpu回收线程数，建议cpu数目的1&#x2F;3</li>
<li>控制何时进行gc，比如到达阈值的80%，预留空间给浮动垃圾</li>
<li>在remark前做一次新生代的垃圾回收，避免要清理的新生代的的对象引用老年代的对象，这样避免remark时重新扫描整个堆进行可达性分析造成的性能影响</li>
</ol>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831155914513.png" alt="image-20220831155914513"></p>
<p>老年代内存不足，stw，（很短的时间）进行初始标记（列举gcroot），用户线程恢复运行，回收线程继续并发标记剩余的垃圾，再次stw，重新标记后进行并发清理。清理时运行cpu产生的垃圾成为浮动垃圾，下次gc时回收</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831160939897.png" alt="image-20220831160939897"></p>
<p>对整个应用程序的吞吐量有影响，</p>
<h3 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h3><p>使用场景：</p>
<ul>
<li>同时注重吞吐量和低延迟</li>
<li>超大堆内存，将堆划分为多个大小相等的额Regin(区域，每个区域1248m,每个区域都可以作为伊甸园、幸存区、老年代)</li>
<li>整体是标记整理算法，两个区域间是复制算法</li>
</ul>
<p>参数：</p>
<ul>
<li>-xx: +UseG1GC</li>
<li>-xx:G1HeapRegionSize&#x3D;size  1248*n</li>
<li>-xx:MaxGcPauseMillis&#x3D;time</li>
</ul>
<h4 id="G1垃圾回收阶段"><a href="#G1垃圾回收阶段" class="headerlink" title="G1垃圾回收阶段"></a>G1垃圾回收阶段</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831163208094.png" alt="image-20220831163208094"></p>
<h4 id="Young-Collection"><a href="#Young-Collection" class="headerlink" title="Young Collection"></a>Young Collection</h4><p>stw的时间相对很短</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831163453346.png" alt="image-20220831163453346"></p>
<p>幸存对象进幸存区</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831163559527.png" alt="image-20220831163559527"></p>
<p>幸存区对象多了，进老年代，不够年龄的拷贝到另一个幸存区</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831163633610.png" alt="image-20220831163633610"></p>
<h4 id="YoungCollection-CM-concurrent-mark"><a href="#YoungCollection-CM-concurrent-mark" class="headerlink" title="YoungCollection+CM(concurrent mark)"></a>YoungCollection+CM(concurrent mark)</h4><ul>
<li>Young GC时会进行GC ROOT初始标记</li>
<li>老年代占用堆空间到达阈值，进行并发标记（不会STW），XX:InitiatingHeapOccupancyPercent&#x3D;percent （默认45%）</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831164145462.png" alt="image-20220831164145462"></p>
<h4 id="Mixed-Collection"><a href="#Mixed-Collection" class="headerlink" title="Mixed Collection"></a>Mixed Collection</h4><p>会对 E、S、O 进行全面垃圾回收</p>
<ul>
<li>最终标记（Remark）会 STW（标记之前标记漏掉的垃圾）</li>
<li>拷贝存活（Evacuation）会 STW</li>
</ul>
<p>-XX:MaxGCPauseMillis&#x3D;ms  </p>
<p>O到O的红线，表示的是，时间不够的情况下，将老年代的部分区域回收，剩下的复制到另一个老年区中，优先清除垃圾最多的区域</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831164509069.png" alt="image-20220831164509069"></p>
<h4 id="Full-GC"><a href="#Full-GC" class="headerlink" title="Full GC"></a>Full GC</h4><ul>
<li>SerialGC<ul>
<li>新生代不足触发的gc –minor gc</li>
<li>老年代不足触发的gc –full gc</li>
</ul>
</li>
<li>ParallelGC<ul>
<li>新生代不足触发的gc –minor gc</li>
<li>老年代不足触发的gc –full gc</li>
</ul>
</li>
<li>CMS<ul>
<li>新生代不足触发的gc –minor gc</li>
<li>老年代不足(和堆内存占比超45%)–混和收集<ul>
<li>当回收速度高于用户进程产生的垃圾时，处于并发垃圾收集阶段</li>
<li>反之退为串行的full gc</li>
</ul>
</li>
</ul>
</li>
<li>G1<ul>
<li>新生代不足触发的gc –minor gc</li>
<li>老年代不足(和堆内存占比超45%)–混和收集<ul>
<li>当回收速度高于用户进程产生的垃圾时，处于并发垃圾收集阶段</li>
<li>反之退为多线程的full gc</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Young-Collention-跨代引用"><a href="#Young-Collention-跨代引用" class="headerlink" title="Young Collention 跨代引用"></a>Young Collention 跨代引用</h4><p>脏卡区域</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831165509319.png" alt="image-20220831165509319"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831165642641.png" alt="image-20220831165642641"></p>
<ul>
<li>卡表与 Remembered Set</li>
<li>在引用变更时通过 post-write barrier + dirty card queue</li>
<li>concurrent refinement threads 更新 Remembered Set</li>
</ul>
<h4 id="Remark"><a href="#Remark" class="headerlink" title="Remark"></a>Remark</h4><p>黑：存活下来的；白：未处理的；灰：正在处理的</p>
<p>最终如果是白色就清除</p>
<p>mark后：</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831170052760.png" alt="image-20220831170052760"></p>
<p>此时，c被改变了：</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831170211743.png" alt="image-20220831170211743"></p>
<p>c有个写屏障(pre-write barrier)，当c被改变时，将c加入到一个队列中（satb_mark_queue），并变成灰色，并发结束进入remark阶段，变成黑色</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831170445257.png" alt="image-20220831170445257"></p>
<h4 id="JDK8字符串去重"><a href="#JDK8字符串去重" class="headerlink" title="JDK8字符串去重"></a>JDK8字符串去重</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831195121019.png" alt="image-20220831195121019"></p>
<h4 id="JDK8并发标记类加载"><a href="#JDK8并发标记类加载" class="headerlink" title="JDK8并发标记类加载"></a>JDK8并发标记类加载</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831195344854.png" alt="image-20220831195344854"></p>
<h4 id="JDK8回收巨型对象"><a href="#JDK8回收巨型对象" class="headerlink" title="JDK8回收巨型对象"></a>JDK8回收巨型对象</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831195445583.png" alt="image-20220831195445583"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831200105037.png" alt="image-20220831200105037"></p>
<h4 id="JDK9并发标记起始时间的调整"><a href="#JDK9并发标记起始时间的调整" class="headerlink" title="JDK9并发标记起始时间的调整"></a>JDK9并发标记起始时间的调整</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831200611426.png" alt="image-20220831200611426"></p>
<h2 id="垃圾回收调优"><a href="#垃圾回收调优" class="headerlink" title="垃圾回收调优"></a>垃圾回收调优</h2><ul>
<li>GC有关的VM参数</li>
<li>相关工具</li>
<li>应用、环境相关</li>
</ul>
<h3 id="调优领域"><a href="#调优领域" class="headerlink" title="调优领域"></a>调优领域</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831203217493.png" alt="image-20220831203217493"></p>
<h3 id="调优目标"><a href="#调优目标" class="headerlink" title="调优目标"></a>调优目标</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831203247571.png" alt="image-20220831203247571"></p>
<h3 id="最快的GC是不发生GC"><a href="#最快的GC是不发生GC" class="headerlink" title="最快的GC是不发生GC"></a>最快的GC是不发生GC</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831204009452.png" alt="image-20220831204009452"></p>
<h3 id="新生代调优"><a href="#新生代调优" class="headerlink" title="新生代调优"></a>新生代调优</h3><p>新生代特点</p>
<ul>
<li>new操作的内存分配非常廉价<ul>
<li>TLAB thread-local allocation buffer 让每个线程用自己私有的伊甸园内存来进行对象的分配，避免多线程</li>
</ul>
</li>
<li>死亡对象的回收代价是0</li>
<li>大部分对象用过即死</li>
<li>Minor GC的时间远远低于Full GC</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831212703382.png" alt="image-20220831212703382"></p>
<ul>
<li>新生代能容纳所有  并发量 * (请求-响应)  的数据  </li>
<li>幸存区大到能保留（当前活跃对象+需要晋升的对象）</li>
<li>晋升阈配置得当，让长时间存活对象尽快晋升</li>
</ul>
<h3 id="老年代调优"><a href="#老年代调优" class="headerlink" title="老年代调优"></a>老年代调优</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831213844957.png" alt="image-20220831213844957"></p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><ul>
<li>Full GC 和 Minor GC频繁</li>
</ul>
<p>​	业务大量创建新对象将新生代塞满，造成幸存区空间紧张，导致晋升阈值降低，很多生存周期很短的对象被加入老年代，进一步触发fullgc的频繁发生。先试着增加新生代的内存空间，内存充裕了，MinorGc降低，同时增加了晋升的阈值，让很多对象留在新生代，老年代的fullgc也不那么频繁</p>
<ul>
<li>高峰期发生Full GC,单次暂停时间特别长（CMS）</li>
</ul>
<p>​	舒适标记和并发标记比较快，慢的是重新标记，这时会扫描整个的堆内存，不光是老年代，也要扫描新生代，高峰时新生代比较多，所以耗时较多。在重新标记发生之前，先对新生代的对象做一次垃圾清理。</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831215203320.png" alt="image-20220831215203320"></p>
<ul>
<li>老年代充裕下，发生Full GC (CMS  jdk1.7)</li>
</ul>
<p>​		cms可能由于空间不足或空间碎片比较多导致并发失败，</p>
<p>1.8中元空间作为方法区的实现，默认的内存空间使用了操作系统的内存空间</p>
<p>1.7永久代作为方法区的实现，永久代的空间不足会导致FullGC（整个堆的）</p>
<h1 id="类加载和字节码技术"><a href="#类加载和字节码技术" class="headerlink" title="类加载和字节码技术"></a>类加载和字节码技术</h1><h2 id="类文件结构"><a href="#类文件结构" class="headerlink" title="类文件结构"></a>类文件结构</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">u4 magic; // 魔数表示是否是class类型的文件 ca fe ba be</span><br><span class="line">u2 minor_version;	//小版本号</span><br><span class="line">u2 major_version;	//主版本号 00 34 jdk8（52）</span><br><span class="line">u2 constant_pool_count;	//常量池中有多少项 00 23表示有34项，第0项不计入，没值</span><br><span class="line">cp_info constant_pool[constant_pool_count-1];//常量池信息</span><br><span class="line">u2 access_flags;//访问标识</span><br><span class="line">u2 this_class; </span><br><span class="line">u2 super_class;</span><br><span class="line">u2 interfaces_count;</span><br><span class="line">u2 interfaces[interfaces_count];</span><br><span class="line">u2 fields_count;</span><br><span class="line">field_info fields[fields_count];//成员变量</span><br><span class="line">u2 methods_count;</span><br><span class="line">method_info methods[methods_count];//方法信息</span><br><span class="line">u2 attributes_count;</span><br><span class="line">attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223037041.png" alt="image-20220831223037041"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223351154.png" alt="image-20220831223351154"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223411093.png" alt="image-20220831223411093"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223427033.png" alt="image-20220831223427033"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223445669.png" alt="image-20220831223445669"></p>
<h3 id="访问标识"><a href="#访问标识" class="headerlink" title="访问标识"></a>访问标识</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223819461.png" alt="image-20220831223819461"></p>
<h3 id="成员变量信息"><a href="#成员变量信息" class="headerlink" title="成员变量信息"></a>成员变量信息</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831223915046.png" alt="image-20220831223915046"></p>
<h3 id="方法信息"><a href="#方法信息" class="headerlink" title="方法信息"></a>方法信息</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831224052756.png" alt="image-20220831224052756"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831224110508.png" alt="image-20220831224110508"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831224132533.png" alt="image-20220831224132533"></p>
<h3 id="附加属性"><a href="#附加属性" class="headerlink" title="附加属性"></a>附加属性</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831224241209.png" alt="image-20220831224241209"></p>
<h2 id="字节码指令"><a href="#字节码指令" class="headerlink" title="字节码指令"></a>字节码指令</h2><h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831224723197.png" alt="image-20220831224723197"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831224750404.png" alt="image-20220831224750404"></p>
<h3 id="javap工具"><a href="#javap工具" class="headerlink" title="javap工具"></a>javap工具</h3><p>javap -v helloworld.class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[root<span class="meta">@localhost</span> ~]# javap -v HelloWorld.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">Classfile</span> /root/HelloWorld.<span class="keyword">class</span></span><br><span class="line"><span class="title class_">Last</span> modified Jul <span class="number">7</span>, <span class="number">2019</span>; size <span class="number">597</span> bytes</span><br><span class="line">MD5 checksum 361dca1c3f4ae38644a9cd5060ac6dbc</span><br><span class="line">Compiled from <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cn</span>.itcast.jvm.t5.HelloWorld</span><br><span class="line">minor version: <span class="number">0</span></span><br><span class="line">major version: <span class="number">52</span></span><br><span class="line">flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">#<span class="number">1</span> = Methodref #<span class="number">6.</span>#<span class="number">21</span> <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">#<span class="number">2</span> = Fieldref #<span class="number">22.</span>#<span class="number">23</span> <span class="comment">//</span></span><br><span class="line">java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">#<span class="number">3</span> = String #<span class="number">24</span> <span class="comment">// hello world</span></span><br><span class="line">#<span class="number">4</span> = Methodref #<span class="number">25.</span>#<span class="number">26</span> <span class="comment">// java/io/PrintStream.println:</span></span><br><span class="line">(Ljava/lang/String;)V</span><br><span class="line">#<span class="number">5</span> = Class #<span class="number">27</span> <span class="comment">// cn/itcast/jvm/t5/HelloWorld</span></span><br><span class="line">#<span class="number">6</span> = Class #<span class="number">28</span> <span class="comment">// java/lang/Object</span></span><br><span class="line">#<span class="number">7</span> = Utf8 &lt;init&gt;</span><br><span class="line">#<span class="number">8</span> = Utf8 ()V</span><br><span class="line">#<span class="number">9</span> = Utf8 Code</span><br><span class="line">#<span class="number">10</span> = Utf8 LineNumberTable</span><br><span class="line">#<span class="number">11</span> = Utf8 LocalVariableTable</span><br><span class="line">#<span class="number">12</span> = Utf8 <span class="built_in">this</span></span><br><span class="line">#<span class="number">13</span> = Utf8 Lcn/itcast/jvm/t5/HelloWorld;#<span class="number">14</span> = Utf8 main</span><br><span class="line">#<span class="number">15</span> = Utf8 ([Ljava/lang/String;)V</span><br><span class="line">#<span class="number">16</span> = Utf8 args</span><br><span class="line">#<span class="number">17</span> = Utf8 [Ljava/lang/String;</span><br><span class="line">#<span class="number">18</span> = Utf8 MethodParameters</span><br><span class="line">#<span class="number">19</span> = Utf8 SourceFile</span><br><span class="line">#<span class="number">20</span> = Utf8 HelloWorld.java</span><br><span class="line">#<span class="number">21</span> = NameAndType #<span class="number">7</span>:#<span class="number">8</span> <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">#<span class="number">22</span> = Class #<span class="number">29</span> <span class="comment">// java/lang/System</span></span><br><span class="line">#<span class="number">23</span> = NameAndType #<span class="number">30</span>:#<span class="number">31</span> <span class="comment">// out:Ljava/io/PrintStream;</span></span><br><span class="line">#<span class="number">24</span> = Utf8 hello world</span><br><span class="line">#<span class="number">25</span> = Class #<span class="number">32</span> <span class="comment">// java/io/PrintStream</span></span><br><span class="line">#<span class="number">26</span> = NameAndType #<span class="number">33</span>:#<span class="number">34</span> <span class="comment">// println:(Ljava/lang/String;)V</span></span><br><span class="line">#<span class="number">27</span> = Utf8 cn/itcast/jvm/t5/HelloWorld</span><br><span class="line">#<span class="number">28</span> = Utf8 java/lang/Object</span><br><span class="line">#<span class="number">29</span> = Utf8 java/lang/System</span><br><span class="line">#<span class="number">30</span> = Utf8 out</span><br><span class="line">#<span class="number">31</span> = Utf8 Ljava/io/PrintStream;</span><br><span class="line">#<span class="number">32</span> = Utf8 java/io/PrintStream</span><br><span class="line">#<span class="number">33</span> = Utf8 println</span><br><span class="line">#<span class="number">34</span> = Utf8 (Ljava/lang/String;)V</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> cn.itcast.jvm.t5.HelloWorld();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">    	stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">            <span class="number">0</span>: aload_0</span><br><span class="line">            <span class="number">1</span>: invokespecial #<span class="number">1</span> <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">            <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">    	LineNumberTable:</span><br><span class="line">    		line <span class="number">4</span>: <span class="number">0</span></span><br><span class="line">   		LocalVariableTable:</span><br><span class="line">    		Start Length Slot Name Signature</span><br><span class="line">   			 <span class="number">0</span> 		<span class="number">5</span> 	 <span class="number">0</span>    <span class="built_in">this</span>  Lcn/itcast/jvm/t5/HelloWorld;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(java.lang.String[])</span>;</span><br><span class="line">   		descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    	flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    	Code:</span><br><span class="line">    		stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">    			<span class="number">0</span>: getstatic #<span class="number">2</span> <span class="comment">// Field</span></span><br><span class="line">   java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">    			<span class="number">3</span>: ldc #<span class="number">3</span> <span class="comment">// String hello world</span></span><br><span class="line">    			<span class="number">5</span>: invokevirtual #<span class="number">4</span> <span class="comment">// Method</span></span><br><span class="line">    java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">    			<span class="number">8</span>: <span class="keyword">return</span></span><br><span class="line">   		 	LineNumberTable:</span><br><span class="line">                line <span class="number">6</span>: <span class="number">0</span></span><br><span class="line">                line <span class="number">7</span>: <span class="number">8</span></span><br><span class="line">    LocalVariableTable:</span><br><span class="line">    		Start Length Slot Name Signature</span><br><span class="line">    			<span class="number">0</span>    <span class="number">9</span>    <span class="number">0</span>   args [Ljava/lang/String;</span><br><span class="line">    MethodParameters:</span><br><span class="line">    Name 							Flags</span><br><span class="line">    args</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h3><ol>
<li><p>原始java代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.jvm.t3.bytecode;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 演示 字节码指令 和 操作数栈、常量池的关系</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_1</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;  <span class="comment">//和方法的字节码指令存在一起</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> Short.MAX_VALUE + <span class="number">1</span>; <span class="comment">//超过整数的最大值，存在常量池中</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> a + b;</span><br><span class="line">        System.out.println(c);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译后的字节码文件</p>
</li>
<li><p>常量池载入运行时常量池</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831231713147.png" alt="image-20220831231713147"></p>
</li>
<li><p>方法字节码载入方法区</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831232212985.png" alt="image-20220831232212985"></p>
</li>
<li><p>main线程开始运行，分配栈帧内存</p>
<p>栈帧中一个是局部变量表一个是操作数栈</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831232548464.png" alt="image-20220831232548464"></p>
</li>
<li><p>执行引擎开始执行字节码</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831232946574.png" alt="image-20220831232946574"></p>
</li>
</ol>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831233046582.png" alt="image-20220831233046582"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831233132366.png" alt="image-20220831233132366"></p>
<p>b的数值大于32767，所以32768&#x3D;Short.MAX_VALUE+1实际上是编译期间计算好的，存在了运行时常量池中，取出来放入操作数栈</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831235417249.png" alt="image-20220831235417249"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831235752930.png" alt="image-20220831235752930"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831235805413.png" alt="image-20220831235805413"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831235934837.png" alt="image-20220831235934837"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220831235946903.png" alt="image-20220831235946903"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000035363.png" alt="image-20220901000035363"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000101596.png" alt="image-20220901000101596"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000113690.png" alt="image-20220901000113690"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000134317.png" alt="image-20220901000134317"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000246772.png" alt="image-20220901000246772"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000320069.png" alt="image-20220901000320069"></p>
<p>执行完毕，弹出栈帧，清除main操作数栈中的内容</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901000414071.png" alt="image-20220901000414071"></p>
<h3 id="分析i"><a href="#分析i" class="headerlink" title="分析i++"></a>分析i++</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.jvm.t3.bytecode;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 从字节码角度分析 a++ 相关题目</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_2</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> a++ + ++a + a--;</span><br><span class="line">        System.out.println(a);</span><br><span class="line">        System.out.println(b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>iinc指令是直接在局部变量slot上执行的</li>
<li>a++和++a 区别是先执行iload还是先执行iinc</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001357263.png" alt="image-20220901001357263"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001405619.png" alt="image-20220901001405619"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001433261.png" alt="image-20220901001433261"></p>
<p>a++</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001605848.png" alt="image-20220901001605848"></p>
<p>++a</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001648566.png" alt="image-20220901001648566"></p>
<p> <img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001732440.png" alt="image-20220901001732440">         </p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001754796.png" alt="image-20220901001754796"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001811146.png" alt="image-20220901001811146"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901001821467.png" alt="image-20220901001821467"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002055866.png" alt="image-20220901002055866"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002105834.png" alt="image-20220901002105834"></p>
<h3 id="条件判断指令"><a href="#条件判断指令" class="headerlink" title="条件判断指令"></a>条件判断指令</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002303656.png" alt="image-20220901002303656"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002325592.png" alt="image-20220901002325592"></p>
<h3 id="循环控制指令"><a href="#循环控制指令" class="headerlink" title="循环控制指令"></a>循环控制指令</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002850892.png" alt="image-20220901002850892"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002905879.png" alt="image-20220901002905879"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901002923257.png" alt="image-20220901002923257"></p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901003145351.png" alt="image-20220901003145351"></p>
<h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><h4 id="V"><a href="#V" class="headerlink" title="()V"></a><cinit>()V</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_8_1</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">    	i = <span class="number">20</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">    	i = <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于静态成员，编译器自上向下收集所有的static静态代码块和静态成员赋值的代码，合并为一个特殊的方法 <strong><cinit>()V</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0: bipush 10</span><br><span class="line">2: putstatic #2 // Field i:I</span><br><span class="line">5: bipush 20</span><br><span class="line">7: putstatic #2 // Field i:I</span><br><span class="line">10: bipush 30</span><br><span class="line">12: putstatic #2 // Field i:I</span><br><span class="line">15: return</span><br></pre></td></tr></table></figure>

<p><cinit>()V在类加载的初始化阶段被调用</p>
<h4 id="V-1"><a href="#V-1" class="headerlink" title="()V"></a><init>()V</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901003836972.png" alt="image-20220901003836972"></p>
<p>编译器会按从上至下的顺序，收集所有 {} 代码块和成员变量赋值的代码，形成新的构造方法，但原始构造方法内的代码总是在最后  </p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901004228951.png" alt="image-20220901004228951"></p>
<h3 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901004649114.png" alt="image-20220901004649114"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901004703630.png" alt="image-20220901004703630"></p>
<ul>
<li><p>invokespecial和invokestatice效率更高，都属于静态绑定</p>
</li>
<li><p>new：在堆空间分配内存，然后将对象的引用放入操作数栈</p>
</li>
<li><p>dup：把栈顶的地址进行复制</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901005329183.png" alt="image-20220901005329183"></p>
</li>
<li><p>invokespecial:根据栈顶的对象引用调用构造方法，然后将栈顶清除</p>
</li>
<li><p>astore1:把剩余的引用d存在局部变量表中去</p>
</li>
<li><p>aload1：在局部变量表中找到d</p>
</li>
<li><p>invokespecial：调d的私有方法</p>
</li>
<li><p>aload1：在局部变量表中找到d</p>
</li>
<li><p>invokespecial：调d的final方法</p>
</li>
<li><p>aload1：在局部变量表中找到d</p>
</li>
<li><p>pop：发现是静态方法，不需要对象来调用，pop掉</p>
</li>
<li><p>invokestatic：静态方法的调用不需要对象，直接调用</p>
</li>
<li><p>invokestatic：类名调用</p>
</li>
<li><p>return</p>
</li>
</ul>
<h3 id="多态的原理"><a href="#多态的原理" class="headerlink" title="多态的原理"></a>多态的原理</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901011810501.png" alt="image-20220901011810501"></p>
<p>输出	吃鱼 我是猫 啃骨头 我是狗</p>
<ul>
<li>先通过栈帧中的对象引用找到对象</li>
<li>分析对象头，找到对象的实际 Class</li>
<li>Class 结构中有 vtable（虚方法表），它在类加载的链接阶段就已经根据方法的重写规则生成好了</li>
<li>查表得到方法的具体地址</li>
<li>执行方法的字节码</li>
</ul>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901012855749.png" alt="image-20220901012855749"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013012939.png" alt="image-20220901013012939"></p>
<p>多个catch块</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013054680.png" alt="image-20220901013054680"></p>
<p>finally</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013245926.png" alt="image-20220901013245926"></p>
<h3 id="练习finally"><a href="#练习finally" class="headerlink" title="练习finally"></a>练习finally</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013449370.png" alt="image-20220901013449370"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013517940.png" alt="image-20220901013517940"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013655236.png" alt="image-20220901013655236"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013736977.png" alt="image-20220901013736977"></p>
<p>有个暂存操作，</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901013752454.png" alt="image-20220901013752454"></p>
<h3 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901014249513.png" alt="image-20220901014249513"></p>
<p>synchronized加在方法上在字节码中不会有体现</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015003031.png" alt="image-20220901015003031"></p>
<h2 id="编译器处理"><a href="#编译器处理" class="headerlink" title="编译器处理"></a>编译器处理</h2><h3 id="语法糖"><a href="#语法糖" class="headerlink" title="语法糖"></a>语法糖</h3><p>java编译器把.java便以为.class字节码的过程中，自动生成和转换的一些代码</p>
<h3 id="默认构造器"><a href="#默认构造器" class="headerlink" title="默认构造器"></a>默认构造器</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015312630.png" alt="image-20220901015312630"></p>
<h3 id="自动拆装箱"><a href="#自动拆装箱" class="headerlink" title="自动拆装箱"></a>自动拆装箱</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015424212.png" alt="image-20220901015424212"></p>
<h3 id="泛型集合取值"><a href="#泛型集合取值" class="headerlink" title="泛型集合取值"></a>泛型集合取值</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015506003.png" alt="image-20220901015506003"></p>
<p>泛型擦除，擦除的是字节码上的泛型信息，在LocalVariableTypeTable中任保留了泛型信息</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015834033.png" alt="image-20220901015834033"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015904614.png" alt="image-20220901015904614"></p>
<h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><p>如果调用的是foo()则等价代码为foo(new String[]{})，创建了一个空的数组，而不会传递null值进去</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901015948146.png" alt="image-20220901015948146"></p>
<h3 id="foreach循环"><a href="#foreach循环" class="headerlink" title="foreach循环"></a>foreach循环</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901020155064.png" alt="image-20220901020155064"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901020327566.png" alt="image-20220901020327566"></p>
<h3 id="switch字符串"><a href="#switch字符串" class="headerlink" title="switch字符串"></a>switch字符串</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901020506200.png" alt="image-20220901020506200"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901020515715.png" alt="image-20220901020515715"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901020916152.png" alt="image-20220901020916152"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901020956445.png" alt="image-20220901020956445"></p>
<h3 id="switch枚举"><a href="#switch枚举" class="headerlink" title="switch枚举"></a>switch枚举</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021032848.png" alt="image-20220901021032848"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021212489.png" alt="image-20220901021212489"></p>
<h3 id="枚举类"><a href="#枚举类" class="headerlink" title="枚举类"></a>枚举类</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021336482.png" alt="image-20220901021336482"></p>
<h3 id="try-with-resources"><a href="#try-with-resources" class="headerlink" title="try-with-resources"></a>try-with-resources</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021444842.png" alt="image-20220901021444842"></p>
<p>…</p>
<h3 id="方法重写时的桥接方法"><a href="#方法重写时的桥接方法" class="headerlink" title="方法重写时的桥接方法"></a>方法重写时的桥接方法</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021701537.png" alt="image-20220901021701537"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021736116.png" alt="image-20220901021736116"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021751526.png" alt="image-20220901021751526"></p>
<h3 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021907543.png" alt="image-20220901021907543"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021928008.png" alt="image-20220901021928008"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901021945680.png" alt="image-20220901021945680"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901022027284.png" alt="image-20220901022027284"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901022113915.png" alt="image-20220901022113915"></p>
<h2 id="类加载阶段"><a href="#类加载阶段" class="headerlink" title="类加载阶段"></a>类加载阶段</h2><h3 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901123808353.png" alt="image-20220901123808353"></p>
<p>对象头 16个字节，前8个对应着class地址，通过这个找到类对象，在元空间找到instanceclass，找到相关信息</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901124205869.png" alt="image-20220901124205869"></p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><ul>
<li>​	验证类是否符合jvm规范，安全性检查</li>
</ul>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><ul>
<li>static变量在jdk7之前存在instanceK末尾存在方法区中，之后本着类对象存储在堆中</li>
<li>static变量分配空间和赋值是两个步骤，分配空间在准备阶段，<strong>赋值在初始化阶段</strong></li>
<li><strong>final类型的基本类型和String常量初始化赋值都在准备阶段</strong></li>
<li><strong>final类型的引用类型的赋值也在初始化阶段完成</strong></li>
</ul>
<h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><ul>
<li>将常量池中的符号引用解析为直接引用</li>
</ul>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>执行 cinit方法</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901130236397.png" alt="image-20220901130236397"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901130507967.png" alt="image-20220901130507967"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901130524117.png" alt="image-20220901130524117"></p>
<h4 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h4><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901131033566.png" alt="image-20220901131033566"></p>
<p>a,b不会(准备阶段初始化)，c会导致E初始化</p>
<h5 id="懒惰初始化的单例模式"><a href="#懒惰初始化的单例模式" class="headerlink" title="懒惰初始化的单例模式"></a>懒惰初始化的单例模式</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SingleTon</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LazyHolder</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton SINGLETON=<span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">        <span class="comment">///静态变量的赋值实在初始化阶段完成的</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.SINGLETON;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h2><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901131854765.png" alt="image-20220901131854765"></p>
<h3 id="启动类加载器"><a href="#启动类加载器" class="headerlink" title="启动类加载器"></a>启动类加载器</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901132537689.png" alt="image-20220901132537689"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901132720838.png" alt="image-20220901132720838"></p>
<h3 id="扩展类加载器"><a href="#扩展类加载器" class="headerlink" title="扩展类加载器"></a>扩展类加载器</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133046089.png" alt="image-20220901133046089"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133053915.png" alt="image-20220901133053915"></p>
<h3 id="双亲委派模式"><a href="#双亲委派模式" class="headerlink" title="双亲委派模式"></a>双亲委派模式</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133208927.png" alt="image-20220901133208927"></p>
<h3 id="线程上下文类加载器"><a href="#线程上下文类加载器" class="headerlink" title="线程上下文类加载器"></a>线程上下文类加载器</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133459852.png" alt="image-20220901133459852"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133618225.png" alt="image-20220901133618225"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133638807.png" alt="image-20220901133638807"></p>
<h4 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h4><p>Serveice Provider Interface</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133825432.png" alt="image-20220901133825432"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901133841257.png" alt="image-20220901133841257"></p>
<p>来得到实现类，而load方法里，又是获取线程上下文类加载器，默认的是应用程序类加载器，内部又是由Class.forName调用了线程上下文类加载器完成类加载，用到该思想的有</p>
<ul>
<li>JDBC</li>
<li>Spring容器</li>
<li>Servlet初始化容器</li>
<li>Dubbo对SPI进行了扩展</li>
</ul>
<h3 id="自定义类加载器"><a href="#自定义类加载器" class="headerlink" title="自定义类加载器"></a>自定义类加载器</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901134501238.png" alt="image-20220901134501238"></p>
<h2 id="运行期优化"><a href="#运行期优化" class="headerlink" title="运行期优化"></a>运行期优化</h2><h3 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h3><p>JVM将执行状态分为了5层</p>
<ul>
<li>0，解释执行，如果字节码被反复调用，就会上升到1层，用编译器执行</li>
<li>1，c1即时编译器编译执行（不带profiling，profiling就是反复调用的次数）</li>
<li>2，c1即时编译器编译执行（带基本的profiling）</li>
<li>3，c1即时编译器编译执行（带完全的profiling）</li>
<li>4，c2即时编译器执行</li>
</ul>
<p>JIT与解释器的区别</p>
<ul>
<li>解释器将字节码解释为机器码（所有平台通用），再次遇到还会重复解释</li>
<li>JIT将字节码编译为机器码（根据平台类型，生成特定机器码），存入code cache，下次遇到直接执行</li>
</ul>
<p><strong>策略</strong>：大部分代码只执行一次，所以无需耗时编译，解释执行即可，将小部分的热点代码编译成机器码，达到理想的运行速度</p>
<p>这种优化措施称为<strong>逃逸分析</strong></p>
<h3 id="方法内联"><a href="#方法内联" class="headerlink" title="方法内联"></a>方法内联</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901140005532.png" alt="image-20220901140005532"></p>
<h3 id="字段优化"><a href="#字段优化" class="headerlink" title="字段优化"></a>字段优化</h3><h3 id="反射优化"><a href="#反射优化" class="headerlink" title="反射优化"></a>反射优化</h3><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901140314641.png" alt="image-20220901140314641"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901141658357.png" alt="image-20220901141658357"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901141810266.png" alt="image-20220901141810266"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901141845203.png" alt="image-20220901141845203"></p>
<h1 id="内存模型JMM"><a href="#内存模型JMM" class="headerlink" title="内存模型JMM"></a>内存模型JMM</h1><p>定义了一套在多线程读写共享数据时（成员变量、数组），对数据的可见性、有序性、和原子性的规则和保障</p>
<h2 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h2><p>synchronized(同步关键字)</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901142801102.png" alt="image-20220901142801102"></p>
<p>每个对象都有自己的monitor区域，监视器，加了synchronized才会考虑</p>
<ul>
<li>owner 同一时刻只有一个线程称为owener</li>
<li>entrylist 阻塞的进程</li>
<li>waitset</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901143105618.png" alt="image-20220901143105618"></p>
<h2 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h2><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901143716684.png" alt="image-20220901143716684"></p>
<ol>
<li><p>初始，t线程从刚开始从主存读取了run到工作内存</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901143937822.png" alt="image-20220901143937822"></p>
</li>
<li><p>t频繁的读run的值，JIT会将run的值放到缓存中提高工作效率<img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901144036979.png" alt="image-20220901144036979"></p>
</li>
<li><p>1s后，main修改了run的值，同步到了主存，而t是从缓存中读的值，结果依然是旧值</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901144408951.png" alt="image-20220901144408951"></p>
</li>
</ol>
<p><strong>解决:volatile</strong>:</p>
<p>用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 volatile 变量都是直接操作主存  </p>
<ul>
<li>只适用于一个写线程多个读线程的情况</li>
<li>synchronized可保证原子性和可见性、但synchronized属于重量级操作，性能相对更低</li>
</ul>
<h2 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h2><p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901144847959.png" alt="image-20220901144847959"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901145016538.png" alt="image-20220901145016538"></p>
<p>这种现象是指令重排，是JIT在运行时的一些优化，多线程下的指令重排会影响正确性</p>
<h3 id="解决-volatile"><a href="#解决-volatile" class="headerlink" title="解决 volatile"></a>解决 volatile</h3><ul>
<li>volatile修饰的变量，禁用指令重排（jdk1.5之后）</li>
</ul>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901145226948.png" alt="image-20220901145226948"></p>
<h3 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h3><p>规定了哪些写操作对其他线程的读操作可见，它是可见性与有序性的一套规则总结</p>
<ul>
<li><p>线程对volatile变量的写，对接下来的其他线程的度读可见</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901150342104.png" alt="image-20220901150342104"></p>
</li>
<li><p>线程解锁m之前对变量的写，对接下来对m加锁的线程的读可见</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901150533830.png" alt="image-20220901150533830"></p>
</li>
<li><p>线程start前对变量的写，对线程开始后对变量的读可见</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901150650194.png" alt="image-20220901150650194"></p>
</li>
<li><p>线程结束前对变量的写，对其他线程得知它结束后读可见</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901150745538.png" alt="image-20220901150745538"></p>
</li>
<li><p>对变量的默认值的写，对其他线程对该变量的读可见</p>
</li>
<li><p>具有传递性</p>
</li>
<li><p>线程t1打断t2前对变量的写，对于其他线程得知t2被打断后的变量的读可见</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901151020627.png" alt="image-20220901151020627"></p>
</li>
</ul>
<p>​	</p>
<h2 id="CAS与原子类"><a href="#CAS与原子类" class="headerlink" title="CAS与原子类"></a>CAS与原子类</h2><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><p>即 Compare and Swap，体现一种<strong>乐观锁</strong>的思想</p>
<p>尝试把结果写入，先比较旧值和共享变量是否相等。</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901151554344.png" alt="image-20220901151554344"></p>
<p>这个共享变量需要用volatile修饰，结合CAS和volatile可以实现无锁并发，适用于竞争不激烈、多核cpu的情况</p>
<ul>
<li>没有使用synchronized,所以线程不会陷入阻塞，这是效率提升的原因</li>
<li>如果竞争激烈的话，CAS必然频繁发生，效率会影响</li>
</ul>
<p>CAS底层用Unsafe类直接调用os底层的CAS指令</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901152242388.png" alt="image-20220901152242388"></p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901152300120.png" alt="image-20220901152300120"></p>
<h3 id="乐观锁和悲观锁"><a href="#乐观锁和悲观锁" class="headerlink" title="乐观锁和悲观锁"></a>乐观锁和悲观锁</h3><ul>
<li>CAS 乐观锁的思想，乐观的估计，不怕别的线程来修改共享变量</li>
<li>Synchronized基于悲观锁的思想，防止其他线程来修改共享变量</li>
</ul>
<h3 id="原子操作类"><a href="#原子操作类" class="headerlink" title="原子操作类"></a>原子操作类</h3><p><strong>juc</strong>（ java.util.concurrent）中提供了原子操作类，提供线程安全的操作，例如：AtomicInteger、AtomicBoolean等 底层用CAS+Volatile</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901153136932.png" alt="image-20220901153136932"></p>
<h2 id="Synchronized优化"><a href="#Synchronized优化" class="headerlink" title="Synchronized优化"></a>Synchronized优化</h2><h3 id="对象头："><a href="#对象头：" class="headerlink" title="对象头："></a>对象头：</h3><ul>
<li>class指针</li>
<li>MarkWord<ul>
<li>该对象的哈希码</li>
<li>分带年龄（gc回收时从幸存区到老年代用到）</li>
</ul>
</li>
<li>加锁时的MarkWord<ul>
<li>标记位</li>
<li>线程锁记录指针</li>
<li>重量级锁指针</li>
<li>线程id</li>
<li>等</li>
</ul>
</li>
</ul>
<h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><p>如果一个对象是多线程访问的，但是访问的时间是错开的，无竞争，可以使用轻量级锁</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901154218643.png" alt="image-20220901154218643"></p>
<p>MarkWord就8个字节，不够用，然后每个线程的栈帧中都有一个锁记录的结构，内部可存储锁定对象的Mark Word</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901154847657.png" alt="image-20220901154847657"></p>
<ol>
<li><p>线程1访问同步块A，把Mark复制到线程1的锁记录</p>
<ul>
<li>mark此时为<strong>01</strong>表示无锁</li>
</ul>
</li>
<li><p>然后CAS修改mark为线程1锁记录的地址</p>
<ul>
<li>如果修改成功了，说明获得所成功</li>
<li>mark此时为<strong>00</strong>表示轻量级锁 +线程一锁记录地址</li>
</ul>
</li>
<li><p>执行同步块A</p>
</li>
<li><p>访问同步块B，把Mark复制到线程1的锁记录</p>
</li>
<li><p>CAS修改Mark为线程一的所记录地址，发现是自己的锁，失败</p>
</li>
<li><p>锁重入</p>
</li>
<li><p>执行同步块B</p>
</li>
<li><p>同步块B执行完毕，弹出一个锁记录地址</p>
</li>
<li><p>同步块A执行完毕</p>
</li>
<li><p>成功（解锁） </p>
<ol>
<li>记录的mardword还回去</li>
<li>锁标记从00改为01</li>
</ol>
</li>
<li><p>线程2来了，重复…</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901161644007.png" alt="image-20220901161644007"></p>
</li>
</ol>
<h3 id="锁膨胀"><a href="#锁膨胀" class="headerlink" title="锁膨胀"></a>锁膨胀</h3><p>尝试在加轻量级锁过程中，CAS失败，这是就是有竞争，需要进行锁膨胀，升级为重量级锁</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901161943444.png" alt="image-20220901161943444"></p>
<p>线程一CAS解锁时会失败，因为对象头里锁状态为10，线程一的锁记录地址也没了，成了重量级锁的指针了。线程一释放重量级锁，其实就是去唤醒阻塞队列</p>
<h3 id="重量锁"><a href="#重量锁" class="headerlink" title="重量锁"></a>重量锁</h3><p>Monitor enter和Monitor exit来完成加锁解锁操作，jdk6后优化，<strong>自旋</strong>（获取锁失败后，转圈重试，先不阻塞）</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901162928492.png" alt="image-20220901162928492"></p>
<p>自旋失败，进入阻塞</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901165521074.png" alt="image-20220901165521074"></p>
<p>同时自旋是自适应的，一次自旋成功，后边就会多自旋，反之就会少自旋甚至不自旋</p>
<ul>
<li>自旋会占用CPU时间，单核CPU自旋就是浪费，多核CPU自旋才能发挥优势</li>
<li>java7之后不能控制是否开启自旋</li>
</ul>
<h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><p>在轻量级锁重入的时候，还是要修改MarkWord的锁记录地址自己为自己，导致资源浪费。</p>
<p>偏向锁只有首次进行CAS操作，不是将锁记录地址存入MarkWord，而是把线程ID设置到MarkWord里，之后发现线程ID是自己的就不用CAS</p>
<ul>
<li>撤销偏向锁是一个重量级操作，需要STW</li>
<li>访问对象的hashcode会撤销偏向锁，因为对象头空间比较金贵，存了线程id，hashcode会被存到加锁的线程里</li>
<li>如果对象虽被多个线程访问，但没竞争，这时偏向了线程1的对象仍有机会<strong>重偏向</strong>到线程2，重偏向会重置对象的Thread ID</li>
<li>撤销偏向和重偏向都是批量进行的，一类为单位</li>
<li>撤销偏向锁到达了某个阈值，整个类的对象都会变为不可偏向锁</li>
<li>-XX:-UseBiasedLocking</li>
</ul>
<h3 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h3><ol>
<li><p>减少上锁时间</p>
</li>
<li><p>减少锁的粒度</p>
<ul>
<li>讲一个锁拆为多个锁提高并发度<ul>
<li>ConcurrentHashMap，1.8中链表头上进行加锁，原来是整个锁住了HashTable，1.8是降低了所得粒度，锁住的只是一个链表，其他的正常读写</li>
<li>LongAdder，计数的一个原子操作类，分为base和cells两部分。无争用的时候，用CAS累加值到base，有争用的时候，去初始化cells数组，每个线程给对应的cell进行修改，最后将每个cell进行累加，再加上base就是最终的值</li>
<li>LinkedBlockingQueue入出对的时候使用不同的锁，相对于LinkedBlockingArray只有一个锁效率更高</li>
</ul>
</li>
</ul>
</li>
<li><p>锁粗化</p>
<ul>
<li><p>多次循环进入同步块不如同步块内多次循环</p>
</li>
<li><p>append里面有锁</p>
<p><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/image-20220901172349989.png" alt="image-20220901172349989"></p>
</li>
</ul>
</li>
<li><p>锁消除</p>
<ul>
<li>JVM会进行代码的逃逸分析，例如某个加锁的对象是方法内局部变量吗，不会被其他线程所访问到，就是被JIT忽略掉所有的同步操作</li>
</ul>
</li>
<li><p>读写分离</p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">yasooh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/08/13/jvm/">http://example.com/2022/08/13/jvm/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">TQYSH</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java-JVM/">java JVM</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/17/Docker/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker</div></div></a></div><div class="next-post pull-right"><a href="/2022/08/10/juc/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">juc</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://typora-ysh.oss-cn-chengdu.aliyuncs.com/typora-img/QQ%E5%9B%BE%E7%89%8720221013163946.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">yasooh</div><div class="author-info__description">总要坚持点什么吧</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F"><span class="toc-number">1.</span> <span class="toc-text">序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM"><span class="toc-number">1.1.</span> <span class="toc-text">JVM?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AF%94%E8%BE%83"><span class="toc-number">1.3.</span> <span class="toc-text">比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%BA%BF"><span class="toc-number">1.4.</span> <span class="toc-text">路线</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">内存结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8-%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">2.1.</span> <span class="toc-text">程序计数器(寄存器)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88"><span class="toc-number">2.2.</span> <span class="toc-text">虚拟机栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%94%E7%A4%BA"><span class="toc-number">2.2.2.</span> <span class="toc-text">演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%A1%E6%A0%88%E5%86%85%E5%AD%98%E5%90%97%EF%BC%9F"><span class="toc-number">2.2.3.</span> <span class="toc-text">垃圾回收管栈内存吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%88%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E8%B6%8A%E5%A4%A7%E8%B6%8A%E5%A5%BD%E5%90%97%EF%BC%9F"><span class="toc-number">2.2.4.</span> <span class="toc-text">栈内存分配越大越好吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%86%85%E7%9A%84%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E6%98%AF%E5%90%A6%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%EF%BC%9F"><span class="toc-number">2.2.5.</span> <span class="toc-text">方法内的局部变量是否线程安全？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%88%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="toc-number">2.2.6.</span> <span class="toc-text">栈内存溢出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88"><span class="toc-number">2.3.</span> <span class="toc-text">本地方法栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86"><span class="toc-number">2.4.</span> <span class="toc-text">堆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="toc-number">2.4.1.</span> <span class="toc-text">堆内存溢出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E8%AF%8A%E6%96%AD"><span class="toc-number">2.4.2.</span> <span class="toc-text">堆内存诊断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA"><span class="toc-number">2.5.</span> <span class="toc-text">方法区</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">2.5.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="toc-number">2.5.2.</span> <span class="toc-text">内存溢出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-number">2.5.3.</span> <span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B8%B8%E9%87%8F%E6%B1%A0%EF%BC%88StringTable%E6%98%AF%E5%85%B6%E4%B8%AD%E9%87%8D%E8%A6%81%E7%9A%84%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86%EF%BC%8C%E5%8F%88%E7%A7%B0%E4%B8%B2%E6%B1%A0%EF%BC%89"><span class="toc-number">2.5.4.</span> <span class="toc-text">运行时常量池（StringTable是其中重要的组成部分，又称串池）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">题目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">2.5.4.2.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">2.5.4.3.</span> <span class="toc-text">面试题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.5.4.4.</span> <span class="toc-text">位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StringTable%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="toc-number">2.5.4.5.</span> <span class="toc-text">StringTable垃圾回收</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StringTable%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="toc-number">2.5.4.6.</span> <span class="toc-text">StringTable性能调优</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98%EF%BC%88Direct-Memory%EF%BC%89"><span class="toc-number">2.6.</span> <span class="toc-text">直接内存（Direct Memory）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2"><span class="toc-number">2.6.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA-1"><span class="toc-number">2.6.2.</span> <span class="toc-text">内存溢出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E5%8E%9F%E7%90%86"><span class="toc-number">2.6.3.</span> <span class="toc-text">释放原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="toc-number">3.</span> <span class="toc-text">垃圾回收</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E5%AF%B9%E8%B1%A1%E5%8F%AF%E4%BB%A5%E5%9B%9E%E6%94%B6"><span class="toc-number">3.1.</span> <span class="toc-text">如何判断对象可以回收</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E6%B3%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">引用计数法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%8A%E7%AB%AF"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">弊端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">可达性分析算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E6%98%AFgc-root%EF%BC%9F"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">哪些是gc root？</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%B1%BB"><span class="toc-number">3.1.2.1.1.</span> <span class="toc-text">基础类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#native%E7%B1%BB"><span class="toc-number">3.1.2.1.2.</span> <span class="toc-text">native类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Busy-Monitor-%E5%8A%A0%E4%BA%86%E9%94%81%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.2.1.3.</span> <span class="toc-text">Busy Monitor,加了锁的对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E7%9A%84%E7%BA%BF%E7%A8%8B%E4%B8%AD%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E6%89%80%E5%BC%95%E7%94%A8%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.2.1.4.</span> <span class="toc-text">活动的线程中局部变量所引用的对象</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">四种引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">垃圾回收算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4"><span class="toc-number">3.2.1.</span> <span class="toc-text">标记清除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86"><span class="toc-number">3.2.2.</span> <span class="toc-text">标记整理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.3.</span> <span class="toc-text">复制算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E4%BB%A3%E5%9B%9E%E6%94%B6"><span class="toc-number">3.3.</span> <span class="toc-text">分代回收</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.0.1.</span> <span class="toc-text">过程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VM%E5%8F%82%E6%95%B0"><span class="toc-number">3.3.0.2.</span> <span class="toc-text">VM参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GC%E5%88%86%E6%9E%90"><span class="toc-number">3.3.0.3.</span> <span class="toc-text">GC分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E5%AF%B9%E8%B1%A1%E7%9B%B4%E6%8E%A5%E6%99%8B%E5%8D%87%E8%80%81%E5%B9%B4%E4%BB%A3"><span class="toc-number">3.3.0.4.</span> <span class="toc-text">大对象直接晋升老年代</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">3.4.</span> <span class="toc-text">垃圾回收器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E8%A1%8C"><span class="toc-number">3.4.1.</span> <span class="toc-text">串行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%9E%E5%90%90%E9%87%8F%E4%BC%98%E5%85%88"><span class="toc-number">3.4.2.</span> <span class="toc-text">吞吐量优先</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E4%BC%98%E5%85%88"><span class="toc-number">3.4.3.</span> <span class="toc-text">响应时间优先</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#G1"><span class="toc-number">3.4.4.</span> <span class="toc-text">G1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#G1%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E9%98%B6%E6%AE%B5"><span class="toc-number">3.4.4.1.</span> <span class="toc-text">G1垃圾回收阶段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Young-Collection"><span class="toc-number">3.4.4.2.</span> <span class="toc-text">Young Collection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YoungCollection-CM-concurrent-mark"><span class="toc-number">3.4.4.3.</span> <span class="toc-text">YoungCollection+CM(concurrent mark)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mixed-Collection"><span class="toc-number">3.4.4.4.</span> <span class="toc-text">Mixed Collection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Full-GC"><span class="toc-number">3.4.4.5.</span> <span class="toc-text">Full GC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Young-Collention-%E8%B7%A8%E4%BB%A3%E5%BC%95%E7%94%A8"><span class="toc-number">3.4.4.6.</span> <span class="toc-text">Young Collention 跨代引用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Remark"><span class="toc-number">3.4.4.7.</span> <span class="toc-text">Remark</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK8%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8E%BB%E9%87%8D"><span class="toc-number">3.4.4.8.</span> <span class="toc-text">JDK8字符串去重</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK8%E5%B9%B6%E5%8F%91%E6%A0%87%E8%AE%B0%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.4.4.9.</span> <span class="toc-text">JDK8并发标记类加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK8%E5%9B%9E%E6%94%B6%E5%B7%A8%E5%9E%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.4.4.10.</span> <span class="toc-text">JDK8回收巨型对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK9%E5%B9%B6%E5%8F%91%E6%A0%87%E8%AE%B0%E8%B5%B7%E5%A7%8B%E6%97%B6%E9%97%B4%E7%9A%84%E8%B0%83%E6%95%B4"><span class="toc-number">3.4.4.11.</span> <span class="toc-text">JDK9并发标记起始时间的调整</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E8%B0%83%E4%BC%98"><span class="toc-number">3.5.</span> <span class="toc-text">垃圾回收调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E4%BC%98%E9%A2%86%E5%9F%9F"><span class="toc-number">3.5.1.</span> <span class="toc-text">调优领域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E4%BC%98%E7%9B%AE%E6%A0%87"><span class="toc-number">3.5.2.</span> <span class="toc-text">调优目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%BF%AB%E7%9A%84GC%E6%98%AF%E4%B8%8D%E5%8F%91%E7%94%9FGC"><span class="toc-number">3.5.3.</span> <span class="toc-text">最快的GC是不发生GC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E7%94%9F%E4%BB%A3%E8%B0%83%E4%BC%98"><span class="toc-number">3.5.4.</span> <span class="toc-text">新生代调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%80%81%E5%B9%B4%E4%BB%A3%E8%B0%83%E4%BC%98"><span class="toc-number">3.5.5.</span> <span class="toc-text">老年代调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">3.5.6.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%AD%97%E8%8A%82%E7%A0%81%E6%8A%80%E6%9C%AF"><span class="toc-number">4.</span> <span class="toc-text">类加载和字节码技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text">类文件结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="toc-number">4.1.1.</span> <span class="toc-text">常量池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%A0%87%E8%AF%86"><span class="toc-number">4.1.2.</span> <span class="toc-text">访问标识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.3.</span> <span class="toc-text">成员变量信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.4.</span> <span class="toc-text">方法信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%84%E5%8A%A0%E5%B1%9E%E6%80%A7"><span class="toc-number">4.1.5.</span> <span class="toc-text">附加属性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="toc-number">4.2.</span> <span class="toc-text">字节码指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javap%E5%B7%A5%E5%85%B7"><span class="toc-number">4.2.2.</span> <span class="toc-text">javap工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3"><span class="toc-number">4.2.3.</span> <span class="toc-text">图解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90i"><span class="toc-number">4.2.4.</span> <span class="toc-text">分析i++</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E6%8C%87%E4%BB%A4"><span class="toc-number">4.2.5.</span> <span class="toc-text">条件判断指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E6%8E%A7%E5%88%B6%E6%8C%87%E4%BB%A4"><span class="toc-number">4.2.6.</span> <span class="toc-text">循环控制指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">4.2.7.</span> <span class="toc-text">练习</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.8.</span> <span class="toc-text">构造方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#V"><span class="toc-number">4.2.8.1.</span> <span class="toc-text">()V</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#V-1"><span class="toc-number">4.2.8.2.</span> <span class="toc-text">()V</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="toc-number">4.2.9.</span> <span class="toc-text">方法调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%80%81%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.10.</span> <span class="toc-text">多态的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">4.2.11.</span> <span class="toc-text">异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0finally"><span class="toc-number">4.2.12.</span> <span class="toc-text">练习finally</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Synchronized"><span class="toc-number">4.2.13.</span> <span class="toc-text">Synchronized</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E5%A4%84%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">编译器处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E7%B3%96"><span class="toc-number">4.3.1.</span> <span class="toc-text">语法糖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">4.3.2.</span> <span class="toc-text">默认构造器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%8B%86%E8%A3%85%E7%AE%B1"><span class="toc-number">4.3.3.</span> <span class="toc-text">自动拆装箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%9B%E5%9E%8B%E9%9B%86%E5%90%88%E5%8F%96%E5%80%BC"><span class="toc-number">4.3.4.</span> <span class="toc-text">泛型集合取值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0"><span class="toc-number">4.3.5.</span> <span class="toc-text">可变参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#foreach%E5%BE%AA%E7%8E%AF"><span class="toc-number">4.3.6.</span> <span class="toc-text">foreach循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#switch%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">4.3.7.</span> <span class="toc-text">switch字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#switch%E6%9E%9A%E4%B8%BE"><span class="toc-number">4.3.8.</span> <span class="toc-text">switch枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB"><span class="toc-number">4.3.9.</span> <span class="toc-text">枚举类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#try-with-resources"><span class="toc-number">4.3.10.</span> <span class="toc-text">try-with-resources</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E9%87%8D%E5%86%99%E6%97%B6%E7%9A%84%E6%A1%A5%E6%8E%A5%E6%96%B9%E6%B3%95"><span class="toc-number">4.3.11.</span> <span class="toc-text">方法重写时的桥接方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB"><span class="toc-number">4.3.12.</span> <span class="toc-text">匿名内部类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%98%B6%E6%AE%B5"><span class="toc-number">4.4.</span> <span class="toc-text">类加载阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD"><span class="toc-number">4.4.1.</span> <span class="toc-text">加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-number">4.4.2.</span> <span class="toc-text">链接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.4.3.</span> <span class="toc-text">初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">练习</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%87%92%E6%83%B0%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.3.1.1.</span> <span class="toc-text">懒惰初始化的单例模式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.5.</span> <span class="toc-text">类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.5.1.</span> <span class="toc-text">启动类加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.5.2.</span> <span class="toc-text">扩展类加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.5.3.</span> <span class="toc-text">双亲委派模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.5.4.</span> <span class="toc-text">线程上下文类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SPI"><span class="toc-number">4.5.4.1.</span> <span class="toc-text">SPI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.5.5.</span> <span class="toc-text">自定义类加载器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%9F%E4%BC%98%E5%8C%96"><span class="toc-number">4.6.</span> <span class="toc-text">运行期优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90"><span class="toc-number">4.6.1.</span> <span class="toc-text">逃逸分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%86%85%E8%81%94"><span class="toc-number">4.6.2.</span> <span class="toc-text">方法内联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E4%BC%98%E5%8C%96"><span class="toc-number">4.6.3.</span> <span class="toc-text">字段优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E4%BC%98%E5%8C%96"><span class="toc-number">4.6.4.</span> <span class="toc-text">反射优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8BJMM"><span class="toc-number">5.</span> <span class="toc-text">内存模型JMM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">5.1.</span> <span class="toc-text">原子性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">5.2.</span> <span class="toc-text">可见性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">5.3.</span> <span class="toc-text">有序性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3-volatile"><span class="toc-number">5.3.1.</span> <span class="toc-text">解决 volatile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#happens-before"><span class="toc-number">5.3.2.</span> <span class="toc-text">happens-before</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS%E4%B8%8E%E5%8E%9F%E5%AD%90%E7%B1%BB"><span class="toc-number">5.4.</span> <span class="toc-text">CAS与原子类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS"><span class="toc-number">5.4.1.</span> <span class="toc-text">CAS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81%E5%92%8C%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-number">5.4.2.</span> <span class="toc-text">乐观锁和悲观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="toc-number">5.4.3.</span> <span class="toc-text">原子操作类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Synchronized%E4%BC%98%E5%8C%96"><span class="toc-number">5.5.</span> <span class="toc-text">Synchronized优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4%EF%BC%9A"><span class="toc-number">5.5.1.</span> <span class="toc-text">对象头：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">5.5.2.</span> <span class="toc-text">轻量级锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E8%86%A8%E8%83%80"><span class="toc-number">5.5.3.</span> <span class="toc-text">锁膨胀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E9%87%8F%E9%94%81"><span class="toc-number">5.5.4.</span> <span class="toc-text">重量锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-number">5.5.5.</span> <span class="toc-text">偏向锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E4%BC%98%E5%8C%96"><span class="toc-number">5.5.6.</span> <span class="toc-text">其他优化</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/17/%E4%B8%AD%E5%8C%BB%E7%A4%BE%E5%8C%BA%E7%B3%BB%E7%BB%9F%E6%95%B4%E7%90%86/" title="中医社区系统整理"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="中医社区系统整理"/></a><div class="content"><a class="title" href="/2022/10/17/%E4%B8%AD%E5%8C%BB%E7%A4%BE%E5%8C%BA%E7%B3%BB%E7%BB%9F%E6%95%B4%E7%90%86/" title="中医社区系统整理">中医社区系统整理</a><time datetime="2022-10-17T07:19:32.000Z" title="发表于 2022-10-17 15:19:32">2022-10-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/09/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98/" title="每日一题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="每日一题"/></a><div class="content"><a class="title" href="/2022/10/09/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98/" title="每日一题">每日一题</a><time datetime="2022-10-09T07:23:32.000Z" title="发表于 2022-10-09 15:23:32">2022-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/01/%E9%9D%A2%E8%AF%95/" title="面试记录"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试记录"/></a><div class="content"><a class="title" href="/2022/10/01/%E9%9D%A2%E8%AF%95/" title="面试记录">面试记录</a><time datetime="2022-10-01T07:23:32.000Z" title="发表于 2022-10-01 15:23:32">2022-10-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/25/%E9%9A%8F%E6%83%B3%E5%BD%95/" title="随想"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="随想"/></a><div class="content"><a class="title" href="/2022/09/25/%E9%9A%8F%E6%83%B3%E5%BD%95/" title="随想">随想</a><time datetime="2022-09-25T07:23:32.000Z" title="发表于 2022-09-25 15:23:32">2022-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/15/%E7%BB%8F%E5%85%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AE%97%E6%B3%95%E9%A2%98/" title="二分搜索"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="二分搜索"/></a><div class="content"><a class="title" href="/2022/09/15/%E7%BB%8F%E5%85%B8%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AE%97%E6%B3%95%E9%A2%98/" title="二分搜索">二分搜索</a><time datetime="2022-09-15T07:23:32.000Z" title="发表于 2022-09-15 15:23:32">2022-09-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By yasooh</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>